build:
  box: golang:1.8
  base-path: /go/src/github.com/wercker/blueprint
  steps:
    - install-packages:
        packages: curl unzip

    - script:
        name: force "go get" over ssh
        code: git config --global url."git@github.com:".insteadOf "https://github.com/"

    - add-ssh-key:
        keyname: WALTERBOT

    - add-to-known_hosts:
        hostname: github.com
        fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48
        type: rsa

    - script:
        name: install protobuf 3
        code: |
          export PROTOBUF_VERSION=3.0.0
          curl -L https://github.com/google/protobuf/releases/download/v${PROTOBUF_VERSION}/protoc-${PROTOBUF_VERSION}-linux-x86_64.zip > /tmp/protoc-${PROTOBUF_VERSION}-linux-x86_64.zip
          cd /tmp
          unzip protoc-${PROTOBUF_VERSION}-linux-x86_64.zip
          export PATH=/tmp/bin:$PATH

    - script:
        name: install govendor
        code: go get -u github.com/kardianos/govendor

    - script:
        name: install dependencies
        code: |
          govendor sync

    - script:
        name: compile
        code: go build

    - script:
        name: init blueprint
        code: |
          rm -rf ./managed
          ./blueprint init service step-registry

    - script:
        name: apply blueprint
        code: |
          touch templates/service/FOO.txt
          ./blueprint apply service step-registry
          [[ -e ./managed/step-registry/FOO.txt ]] || exit 1

    - script:
        name: install protobuf plugins
        code: |
          export PROTOC_GRPC_VERSION=v1.2.2

          go get -u github.com/grpc-ecosystem/grpc-gateway/protoc-gen-grpc-gateway
          go get -u github.com/grpc-ecosystem/grpc-gateway/protoc-gen-swagger

          # Switch to tag
          cd $GOPATH/src/github.com/grpc-ecosystem/grpc-gateway
          git checkout $PROTO_GRPC_VERSION
          cd protoc-gen-grpc-gateway
          go install
          cd ../protoc-gen-swagger
          go install

          go get -u github.com/golang/protobuf/protoc-gen-go
          cd $GOPATH/src/github.com/golang/protobuf
          export PROTOC_GO_VERSION=$(git rev-parse HEAD)

          go get -u github.com/wercker/protoc-gen-flow
          cd $GOPATH/src/github.com/wercker/protoc-gen-flow
          export PROTOC_FLOW_VERSION=$(git rev-parse HEAD)

    - script:
        name: test output
        code: |
          mv ./managed/step-registry ../step-registry
          cd ../step-registry
          govendor sync
          govendor generate +local
          go build
          cp -r ./ $WERCKER_REPORT_ARTIFACTS_DIR/step-registry

proto-box:
  box: golang:1.8
  base-path: /go/src/github.com/wercker/blueprint
  steps:
    - install-packages:
        packages: curl unzip

    - script:
        name: force "go get" over ssh
        code: git config --global url."git@github.com:".insteadOf "https://github.com/"

    - add-ssh-key:
        keyname: WALTERBOT

    - add-to-known_hosts:
        hostname: github.com
        fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48
        type: rsa

    - script:
        name: install protobuf 3
        code: |
          export PROTOBUF_VERSION=3.3.0
          curl -L https://github.com/google/protobuf/releases/download/v${PROTOBUF_VERSION}/protoc-${PROTOBUF_VERSION}-linux-x86_64.zip > /tmp/protoc-${PROTOBUF_VERSION}-linux-x86_64.zip
          cd /tmp
          unzip protoc-${PROTOBUF_VERSION}-linux-x86_64.zip
          mv -v include/* /usr/local/include/
          mv -v bin/* /usr/local/bin

    - script:
        name: install protobuf plugins
        code: |
          export PROTOC_GRPC_VERSION=v1.2.2

          go get -u github.com/grpc-ecosystem/grpc-gateway/protoc-gen-grpc-gateway
          go get -u github.com/grpc-ecosystem/grpc-gateway/protoc-gen-swagger

          # Switch to tag
          cd $GOPATH/src/github.com/grpc-ecosystem/grpc-gateway
          git checkout $PROTO_GRPC_VERSION
          cd protoc-gen-grpc-gateway
          go install
          cd ../protoc-gen-swagger
          go install

          go get -u github.com/golang/protobuf/protoc-gen-go
          cd $GOPATH/src/github.com/golang/protobuf
          export PROTOC_GO_VERSION=$(git rev-parse HEAD)

          go get -u github.com/wercker/protoc-gen-flow
          cd $GOPATH/src/github.com/wercker/protoc-gen-flow
          export PROTOC_FLOW_VERSION=$(git rev-parse HEAD)

          echo "protobuf: $PROTOBUF_VERSION"
          echo "protoc-gen-grpc-gateway: $PROTOC_GRPC_VERSION"
          echo "protoc-gen-swagger: $PROTOC_GRPC_VERSION"
          echo "protoc-gen-go: $PROTOC_GO_VERSION"
          echo "protoc-gen-flow: $PROTOC_FLOW_VERSION"

    - bash-template:
        name: generate protoc script
        input: templates/protoc.sh
        output: /protoc.sh

    - script:
        name: make protoc executable
        code: cat /protoc.sh && chmod +x /protoc.sh

    - script:
        name: prune
        code: rm -rf /pipeline /tmp/*

    - internal/docker-push:
        repository: quay.io/wercker/protoc
        registry: https://quay.io
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        entrypoint: /protoc.sh
